var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};class t{registry=new Map;register(e){return t=>(e||(e=t.name),this.registry.set(e,t),t)}get(e){return this.registry.get(e)}getAll(){return this.registry}has(e){return this.registry.has(e)}}var s,r,a,n,i,o,l,c=function(e,t,s,r){var a,n=arguments.length,i=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if('object'==typeof Reflect&&'function'==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(i=(n<3?a(i):n>3?a(t,s,i):a(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i},u=function(e,t){if('object'==typeof Reflect&&'function'==typeof Reflect.metadata)return Reflect.metadata(e,t)};class g{static registry=new t;constructor(...e){}static fromObject(e){return this.prototype.fromObject(e)}}let h=s=class extends g{low;high;num;constructor(e,t,s){super(),this.low=e,this.high=t,this.num=s}fromObject(e){const t=e.low,r=e.high,a=e.num;return new s(t,r,a)}get TYPE(){return'num'}getValue(){return{low:this.low,high:this.high,num:this.num}}getLow(){return this.low}getHigh(){return this.high}getNum(){return this.num}deltaLow(e){null===e?this.low=null:null===this.low?this.low=e:this.low+=e,this.applyConstrain()}deltaHigh(e){null===e?this.high=null:null===this.high?this.high=e:this.high+=e,this.applyConstrain()}deltaNum(e){this.num+=e,this.applyConstrain()}applyConstrain(){null!==this.low&&this.num<this.low&&(this.num=this.low),null!==this.high&&this.num>this.high&&(this.num=this.high)}};h=s=c([g.registry.register(h.prototype.TYPE),u('design:paramtypes',[Object,Object,Number])],h);let d=r=class extends g{str;constructor(e){super(),this.str=e}fromObject(e){const t=e.str;return new r(t)}get TYPE(){return'str'}getValue(){return{str:this.str}}getStr(){return this.str}setStr(e){this.str=e}};d=r=c([g.registry.register(d.prototype.TYPE),u('design:paramtypes',[String])],d);let m=a=class extends g{datetime;constructor(e){super(),this.datetime=new Date(e)}fromObject(e){const t=e.datetime;return new a(t)}get TYPE(){return'datetime'}getValue(){return{datetime:this.datetime}}getYear(){return this.datetime.getFullYear()}getMonth(){return this.datetime.getMonth()}getDate(){return this.datetime.getDate()}getHours(){return this.datetime.getHours()}getMinutes(){return this.datetime.getMinutes()}getSeconds(){return this.datetime.getSeconds()}getDay(){return this.datetime.getDay()}getDateTime(){return this.datetime}deltaDatetime(e,t,s,r,a,n){this.datetime.setFullYear(this.datetime.getFullYear()+e),this.datetime.setMonth(this.datetime.getMonth()+t),this.datetime.setDate(this.datetime.getDate()+s),this.datetime.setHours(this.datetime.getHours()+r),this.datetime.setMinutes(this.datetime.getMinutes()+a),this.datetime.setSeconds(this.datetime.getSeconds()+n)}};m=a=c([g.registry.register(m.prototype.TYPE),u('design:paramtypes',['function'==typeof(o='undefined'!=typeof Date&&Date)?o:Object])],m);let y=n=class extends g{outcome;random_events;constructor(e,t){super(),this.outcome=e,this.random_events=t}fromObject(e){const t=e?.outcome,s=e.random_events;return new n(t,s)}get TYPE(){return'random'}getValue(){return{outcome:this.outcome,random_events:this.random_events}}roll(){this.outcome=function(e){let t=0;for(const s of e)t+=s.weighting;let s=Math.random()*t;for(const t of e)if(s-=t.weighting,s<=0)return t.event;return e[-1].event}(this.random_events)}};y=n=c([g.registry.register(y.prototype.TYPE),u('design:paramtypes',[Object,Array])],y);let p=i=class extends g{map;constructor(e){if(super(),this.map=new Map,e)for(const[t,s]of Object.entries(e)){const e=g.registry.get(s.type)?.fromObject(s.values);e&&this.map.set(t,e)}}get TYPE(){return'map'}fromObject(e){return new i(e)}getValue(){const e={};for(const[t,s]of this.map.entries())e[t]={type:s.TYPE,values:s.getValue()};return e}getVariable(e){return this.map.get(e)}setVariable(e,t){this.map.set(e,t)}deleteVariable(e){this.map.delete(e)}get size(){return this.map.size}keys(){return this.map.keys()}};p=i=c([g.registry.register(p.prototype.TYPE),u('design:paramtypes',['function'==typeof(l='undefined'!=typeof Record&&Record)?l:Object])],p);var b,f,V,E,k,w,S,v,N,T,x,D,M,O,R,G,j=function(e,t,s,r){var a,n=arguments.length,i=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if('object'==typeof Reflect&&'function'==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(i=(n<3?a(i):n>3?a(t,s,i):a(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i},P=function(e,t){if('object'==typeof Reflect&&'function'==typeof Reflect.metadata)return Reflect.metadata(e,t)};class C{static registry=new t;constructor(...e){}static parseString(e){if(void 0===e)return[];return[...e.matchAll(this.prototype.REGEX)].map(e=>({command:this.prototype.create(e.slice(1).map(e=>e.trim())),index:e.index})).filter(({command:e})=>e.isValid())}}class A extends C{}let X=b=class extends C{key;low;high;num;constructor(e,t,s,r){super(),this.key=e,this.low=t,this.high=s,this.num=r}get REGEX(){return/init_num\s*\(\s*([^(),:]+?)\s*,\s*([^(),:]+?)\s*,\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s='null'===e[1]?null:Number(e[1]),r='null'===e[2]?null:Number(e[2]),a=Number(e[3]);return new b(t,s,r,a)}isValid(){return(null===this.low||!isNaN(this.low))&&((null===this.high||!isNaN(this.high))&&(!isNaN(this.num)&&!(null!==this.low&&null!==this.high&&this.low>this.high)))}execute(e){const t=new h(this.low,this.high,this.num);return e.setVariable(this.key,t),e}};X=b=j([C.registry.register(),P('design:paramtypes',[String,Object,Object,Number])],X);let Y=f=class extends C{key;delta;constructor(e,t){super(),this.key=e,this.delta=t}get REGEX(){return/delta_num\s*\(\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s=Number(e[1]);return new f(t,s)}isValid(){return!isNaN(this.delta)}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof h==!1||(t.deltaNum(this.delta),e.setVariable(this.key,t)),e}};Y=f=j([C.registry.register(),P('design:paramtypes',[String,Number])],Y);let I=V=class extends C{key;delta;constructor(e,t){super(),this.key=e,this.delta=t}get REGEX(){return/delta_low\s*\(\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s='null'===e[1]?null:Number(e[1]);return new V(t,s)}isValid(){return null===this.delta||!isNaN(this.delta)}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof h==!1||(t.deltaLow(this.delta),e.setVariable(this.key,t)),e}};I=V=j([C.registry.register(),P('design:paramtypes',[String,Object])],I);let L=E=class extends C{key;delta;constructor(e,t){super(),this.key=e,this.delta=t}get REGEX(){return/delta_high\s*\(\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s='null'===e[1]?null:Number(e[1]);return new E(t,s)}isValid(){return null===this.delta||!isNaN(this.delta)}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof h==!1||(t.deltaHigh(this.delta),e.setVariable(this.key,t)),e}};L=E=j([C.registry.register(),P('design:paramtypes',[String,Object])],L);let H=k=class extends C{key;str;constructor(e,t){super(),this.key=e,this.str=t}get REGEX(){return/init_str\s*\(\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s=e[1];return new k(t,s)}isValid(){return!0}execute(e){const t=new d(this.str);return e.setVariable(this.key,t),e}};H=k=j([C.registry.register(),P('design:paramtypes',[String,String])],H);let U=w=class extends C{key;str;constructor(e,t){super(),this.key=e,this.str=t}get REGEX(){return/set_str\s*\(\s*([^(),:]+?)\s*,\s*([^)]+?)\s*\)/g}create(e){const t=e[0],s=e[1];return new w(t,s)}isValid(){return!0}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof d==!1||(t.setStr(this.str),e.setVariable(this.key,t)),e}};U=w=j([C.registry.register(),P('design:paramtypes',[String,String])],U);let B=S=class extends C{key;datetime_string;constructor(e,t){super(),this.key=e,this.datetime_string=t}get REGEX(){return/init_datetime\(([^,:]+),\s*([^)]+)\)/g}create(e){const t=e[0],s=e[1];return new S(t,s)}isValid(){const e=new Date(this.datetime_string);return!isNaN(e.getTime())}execute(e){const t=new Date(this.datetime_string),s=new m(t);return e.setVariable(this.key,s),e}};B=S=j([C.registry.register(),P('design:paramtypes',[String,String])],B);let F=v=class extends C{key;delta_year;delta_month;delta_date;delta_hour;delta_minute;delta_second;constructor(e,t,s,r,a,n,i){super(),this.key=e,this.delta_year=t,this.delta_month=s,this.delta_date=r,this.delta_hour=a,this.delta_minute=n,this.delta_second=i}get REGEX(){return/delta_datetime\(([^,]+),\s*([^)]+),\s*([^)]+),\s*([^)]+),\s*([^)]+),\s*([^)]+),\s*([^)]+)\)/g}create(e){const t=e[0],s=Number(e[1]),r=Number(e[2]),a=Number(e[3]),n=Number(e[4]),i=Number(e[5]),o=Number(e[6]);return new v(t,s,r,a,n,i,o)}isValid(){return!isNaN(this.delta_year)&&(!isNaN(this.delta_month)&&(!isNaN(this.delta_date)&&(!isNaN(this.delta_hour)&&(!isNaN(this.delta_minute)&&!isNaN(this.delta_second)))))}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof m==!1||(t.deltaDatetime(this.delta_year,this.delta_month,this.delta_date,this.delta_hour,this.delta_minute,this.delta_second),e.setVariable(this.key,t)),e}};F=v=j([C.registry.register(),P('design:paramtypes',[String,Number,Number,Number,Number,Number,Number])],F);let W=N=class extends C{command_name;key;delta;constructor(e,t,s){super(),this.command_name=e,this.key=t,this.delta=s}get REGEX(){return/(delta_year|delta_month|delta_date|delta_hour|delta_minute|delta_second)\(([^,]+),\s*([^)]+)\)/g}create(e){const t=e[0],s=e[1],r=Number(e[2]);return new N(t,s,r)}isValid(){return!isNaN(this.delta)}execute(e){const t=e.getVariable(this.key);if(null===t||t instanceof m==!1)return e;const s='delta_year'===this.command_name?this.delta:0,r='delta_month'===this.command_name?this.delta:0,a='delta_date'===this.command_name?this.delta:0,n='delta_hour'===this.command_name?this.delta:0,i='delta_minute'===this.command_name?this.delta:0,o='delta_second'===this.command_name?this.delta:0;return t.deltaDatetime(s,r,a,n,i,o),e.setVariable(this.key,t),e}};W=N=j([C.registry.register(),P('design:paramtypes',[String,String,Number])],W);let K=T=class extends C{key;random_events;constructor(e,t){super(),this.key=e,this.random_events=t}get REGEX(){return/init_random\(\s*([^,]+)\s*,\s*(.+)\s*\)/g}create(e){const t=e[0],s=e[1],r=[];for(const e of s.split(',')){const[t,s]=e.split(':');r.push({event:t,weighting:Number(s)})}return new T(t,r)}isValid(){for(const e of this.random_events)if(Number.isNaN(e.weighting))return!1;return!0}execute(e){const t=new y(null,this.random_events);return e.setVariable(this.key,t),e}};K=T=j([C.registry.register(),P('design:paramtypes',[String,Array])],K);let q=x=class extends A{key;constructor(e){super(),this.key=e}get REGEX(){return/roll\(\s*([^,()]+)\s*\)/g}create(e){const t=e[0];return new x(t)}isValid(){return!0}execute(e){const t=e.getVariable(this.key);return null===t||t instanceof y==!1||(t.roll(),e.setVariable(this.key,t)),e}getRestoreKeys(e){return[this.key]}};q=x=j([C.registry.register(),P('design:paramtypes',[String])],q);let J=D=class extends C{key;constructor(e){super(),this.key=e}get REGEX(){return/delete\(([^,()]+)\s*\)/g}create(e){const t=e[0];return new D(t)}isValid(){return!0}execute(e){return e.deleteVariable(this.key),e}};J=D=j([C.registry.register(),P('design:paramtypes',[String])],J);let Q=M=class extends C{key;constructor(e){super(),this.key=e}get REGEX(){return/init_map\(\s*([^,]+)\s*\)/g}create(e){const t=e[0];return new M(t)}isValid(){return!0}execute(e){const t=new p;return e.setVariable(this.key,t),e}};Q=M=j([C.registry.register(),P('design:paramtypes',[String])],Q);let Z=O=class extends C{map_key;variable_key;constructor(e,t){super(),this.map_key=e,this.variable_key=t}get REGEX(){return/add_map\(\s*([^,]+)\s*,\s*(.+)\s*\)/g}create(e){const t=e[0],s=e[1];return new O(t,s)}isValid(){return!0}execute(e){const t=e.getVariable(this.map_key);if(null===t||t instanceof p==!1)return e;const s=e.getVariable(this.variable_key);return null===s||(t.setVariable(this.variable_key,s),e.deleteVariable(this.variable_key),e.setVariable(this.map_key,t)),e}};Z=O=j([C.registry.register(),P('design:paramtypes',[String,String])],Z);let ee=R=class extends C{map_key;variable_key;constructor(e,t){super(),this.map_key=e,this.variable_key=t}get REGEX(){return/pop_map\(\s*([^,]+)\s*,\s*(.+)\s*\)/g}create(e){const t=e[0],s=e[1];return new R(t,s)}isValid(){return!0}execute(e){const t=e.getVariable(this.map_key);if(null===t||t instanceof p==!1)return e;const s=t.getVariable(this.variable_key);return void 0===s||(t.deleteVariable(this.variable_key),e.setVariable(this.variable_key,s),e.setVariable(this.map_key,t)),e}};ee=R=j([C.registry.register(),P('design:paramtypes',[String,String])],ee);let te=G=class extends C{map_key;variable_key;constructor(e,t){super(),this.map_key=e,this.variable_key=t}get REGEX(){return/delete_map\(\s*([^,]+)\s*,\s*(.+)\s*\)/g}create(e){const t=e[0],s=e[1];return new G(t,s)}isValid(){return!0}execute(e){const t=e.getVariable(this.map_key);return null===t||t instanceof p==!1||(t.deleteVariable(this.variable_key),e.setVariable(this.map_key,t)),e}};te=G=j([C.registry.register(),P('design:paramtypes',[String,String])],te);class se{commands=[];constructor(e){this.commands=e??[]}pushCommand(e){this.commands.push(e)}static fromString(e,t='normal'){let s=e.split('<UserPerspective>');if(!e.includes('<VTC>'))return new se;s=s[s.length-1].split('<VTC>');const r=s[s.length-1].split('</VTC>')[0];let a=[];for(const e of C.registry.getAll().values())'normal'===t&&e.prototype instanceof A||('post'!==t||e.prototype instanceof A)&&(a=a.concat(e.parseString(r)));a.sort((e,t)=>e.index-t.index);const n=a.map(e=>e.command);return console.log('[VariableTracker] commands:',n),new se(n)}execute(e){for(const t of this.commands)t.execute(e);return e}*[Symbol.iterator](){for(const e of this.commands)yield e}}const re=_;var ae=e.n(re);class ne{state;constructor(e){this.state=e?e.state:new Map}static fromVariables(e){const t=new ne;if(null===e)return t;for(const[s,r]of Object.entries(e)){const e=g.registry.get(r.type)?.fromObject(r.values);e&&t.setVariable(s,e)}return t}toVariables(){const e={};for(const[t,s]of this.state)e[t]={type:s.TYPE,values:s.getValue()};return e}getVariable(e){return this.state.get(e)??null}setVariable(e,t){this.state.set(e,t)}deleteVariable(e){this.state.delete(e)}}const ie={type:'chat'};function oe(e){return e<0&&(e=getLastMessageId()+e+1),e}function le(){const e=getVariables(ie).current??null;return ne.fromVariables(e)}function ce(e){const t=getVariables(ie);t.current=e.toVariables(),replaceVariables(t,ie)}function ue(){const e=getVariables(ie);e.current={},replaceVariables(e,ie)}function ge(e){if(0===e)ue();else{const t=e-1;ce(he(t,ye(t)))}}function he(e,t){e=oe(e);const s=getVariables(ie);return ne.fromVariables(s.history[e][t])}function de(e,t=-1,s){t=oe(t);const r=getVariables(ie);r.history=r.history??[],r.history[t]=r.history[t]??[],r.history[t][s]=e.toVariables(),replaceVariables(r,ie)}function me(e){const t=getVariables(ie);t.history&&(t.history.splice(e),replaceVariables(t,ie))}function ye(e){return getChatMessages(e,{include_swipes:!0})[0].swipe_id}function pe(e){return getChatMessages(e,{include_swipes:!0})[0].swipes.length}function be(e,t){let s;console.log('[VariableTracker] executeCommand strat'),s=void 0===t?getChatMessages(e)[0].message:getChatMessages(e,{include_swipes:!0})[0].swipes[t];const r=se.fromString(s);console.log('[VariableTracker] commands:',r);const a=le();r.execute(a),console.log('[VariableTracker] state:',a),ce(a),console.log('[VariableTracker] executeCommand end')}function fe(e,t){let s;console.log('[VariableTracker] executePostCommand strat'),s=void 0===t?getChatMessages(e)[0].message:getChatMessages(e,{include_swipes:!0})[0].swipes[t];const r=se.fromString(s,'post');console.log('[VariableTracker] post commands:',r);const a=le();r.execute(a),console.log('[VariableTracker] state:',a),ce(a),console.log('[VariableTracker] executePostCommand end')}function _e(e,t){t||(t=ye(e));const s=getChatMessages(e,{include_swipes:!0})[0].swipes[t],r=se.fromString(s,'post'),a=he(e,t),n=e+1,i=he(n,ye(n));for(const e of r){const t=e;for(const e of t.getRestoreKeys(a)){const t=i.getVariable(e);t&&a.setVariable(e,t)}}de(a,e,t)}function Ve(e){ge(e);for(let t=e;t<=getLastMessageId();t++){console.log('[DEBUG] message_id:',t);for(let e=0;e<pe(t);e++)be(t,e),de(le(),t,e),ge(t);ce(he(t,ye(t)))}}eventOn(tavern_events.MESSAGE_SENT,async e=>{console.log('[VariableTracker] MESSAGE_SENT strat'),be(e),fe(e);const t=ye(e);de(le(),e,t),console.log('[VariableTracker] MESSAGE_SENT end')}),eventOn(tavern_events.MESSAGE_UPDATED,async e=>{await new Promise(e=>setTimeout(e,100)),console.log('[VariableTracker] MESSAGE_UPDATED strat');const t=pe(e=Number(e)),s=function(e){return e=oe(e),getVariables(ie).history[e].length}(e);if(t<s){!function(e,t){const s=getVariables(ie);s.history&&(s.history[e].splice(t,1),replaceVariables(s,ie))}(e,ye(e))}ge(e),Ve(e),0!==e&&_e(e-1),console.log('[VariableTracker] MESSAGE_UPDATED end')}),eventOn(tavern_events.MESSAGE_RECEIVED,async e=>{console.log('[VariableTracker] MESSAGE_RECEIVED strat'),be(e),fe(e);const t=ye(e);de(le(),e,t),console.log('[VariableTracker] MESSAGE_RECEIVED end')}),eventOn(tavern_events.MESSAGE_SWIPED,async e=>{console.log('[VariableTracker] MESSAGE_SWIPED strat');const t=ye(e),s=0===e?null:e-1;if(function(e,t){return t<getChatMessages(e,{include_swipes:!0})[0].swipes.length}(e,t))ce(he(e,t)),null!==s&&_e(s);else if(null!==s){ge(s),0!==s&&(be(s-1),fe(s-1));const e=ye(s);fe(s),de(le(),s,e)}else ue();console.log('[VariableTracker] MESSAGE_SWIPED end')}),eventOn(tavern_events.MESSAGE_DELETED,async e=>{console.log('[VariableTracker] MESSAGE_DELETED strat');const t=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});let s,r;s=getCharData('current')?.first_mes?'assistant':'user';for(const e of t){if(e.role!==s){r=e.message_id;break}s='assistant'===s?'user':'assistant'}r||(r=t.length),ge(r),me(r),deleteChatMessages(ae().range(r,getLastMessageId()+1)),console.log('[VariableTracker] MESSAGE_DELETED end')}),eventOn(getButtonEvent('清除所有變數'),function(){toastr.info('開始清除所有變數...','VariableTracker Debug');const e=getVariables(ie);e.current={},e.history=[],replaceVariables(e,ie),toastr.success('所有變數已清除！','VariableTracker Debug')}),eventOn(getButtonEvent('重新讀取所有變數'),async function(){toastr.info('開始重新讀取所有變數...','VariableTracker Debug');try{me(0),Ve(0)}catch(e){return console.error('[VariableTracker] 重新讀取變數時發生錯誤:',e),void toastr.error('重新讀取變數失敗，請檢查控制台日誌','VariableTracker Debug')}toastr.success('所有變數已重新讀取完成！','VariableTracker Debug')});